<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>视觉里程计2 - XLMaverick - garabatear of yang</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Yang" />
  <meta name="description" content="视觉里程计2 习题二：直接法 2.1 单层直接法 我们说直接法是光流的直观拓展。在光流中，我们估计的是每个像素的平移(在additive的情况下)。而在" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="https://xlmaverick.me/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b1679e57eeea2063968c2297b106a28a5f8588a822aaea6ec3e802853d3ee8cb.css" integrity="sha256-sWeeV&#43;7qIGOWjCKXsQaiil&#43;FiKgiqupuw&#43;gChT0&#43;6Ms=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="视觉里程计2" />
<meta property="og:description" content="视觉里程计2 习题二：直接法 2.1 单层直接法 我们说直接法是光流的直观拓展。在光流中，我们估计的是每个像素的平移(在additive的情况下)。而在" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xlmaverick.me/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" />



<meta property="article:published_time" content="2019-05-16T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2019-05-20T00:00:00&#43;00:00"/>











<meta itemprop="name" content="视觉里程计2">
<meta itemprop="description" content="视觉里程计2 习题二：直接法 2.1 单层直接法 我们说直接法是光流的直观拓展。在光流中，我们估计的是每个像素的平移(在additive的情况下)。而在">


<meta itemprop="datePublished" content="2019-05-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-05-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3645">



<meta itemprop="keywords" content="slam,十四讲," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="视觉里程计2"/>
<meta name="twitter:description" content="视觉里程计2 习题二：直接法 2.1 单层直接法 我们说直接法是光流的直观拓展。在光流中，我们估计的是每个像素的平移(在additive的情况下)。而在"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">XLMaverick</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/about/">关于</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      XLMaverick
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/about/">关于</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">视觉里程计2</h1>
      
      <div class="post-meta">
        <time datetime="2019-05-16" class="post-time">
          2019-05-16
        </time>
        <div class="post-category">
            <a href="https://xlmaverick.me/categories/slam/"> slam </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" class="leancloud_visitors" data-flag-title="视觉里程计2">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#视觉里程计2">视觉里程计2</a>
<ul>
<li><a href="#习题二-直接法">习题二：直接法</a>
<ul>
<li><a href="#2-1-单层直接法">2.1 单层直接法</a>
<ul>
<li><a href="#答案">答案：</a></li>
<li><a href="#题记">题记：</a></li>
</ul></li>
<li><a href="#2-2-多层直接法">2.2 多层直接法</a>
<ul>
<li><a href="#答案-1">答案：</a></li>
</ul></li>
<li><a href="#2-3-延伸讨论">2.3 延伸讨论</a>
<ul>
<li><a href="#答案-2">答案：</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h1 id="视觉里程计2">视觉里程计2</h1>

<h2 id="习题二-直接法">习题二：直接法</h2>

<h3 id="2-1-单层直接法">2.1 单层直接法</h3>

<p>我们说直接法是光流的直观拓展。在光流中，我们估计的是每个像素的平移(在<code>additive</code>的情况下)。而在直接法当中，我们最小化光流误差，来估计相机的旋转和平移(以李代数的形式)。现在我们将使用和前一个习题非常相似的做法来实现直接法,请同学体现二者之间的紧密联系。<br />
本习题中，你将使用<code>Kitti</code>数据集中的一些图像。给定<code>left.png</code>和<code>disparity.png</code>，我们知道，通过这两个图可以得到<code>left.png</code>中任意一点的3D信息。现在，请你使用直接法，估计图像<code>000001.png</code>至<code>000005.png</code>的相机位姿。我们称<code>left.png</code>为参考图像(<code>reference</code>，简称<code>ref</code>)，称<code>000001.png -000005.png</code>中任意一图为当前图像(<code>current</code>，简称cur)，如下图所示。设待估计的目标为 $ T_ {cur,ref} $ ，那么在<code>ref</code>中取一组点 $ { p_ i } $ ，位姿可以通过最小化下面的目标函数求解:</p>

<p>
$$
\mathbf{T}_{\mathrm{cur}, \mathrm{ref}}=\frac{1}{N} \sum_{i=1}^{N} \sum_{W_{i}}\left\|I_{\mathrm{ref}}\left(\mathbf{p}_{i}\right)-I_{\mathrm{cur}}\left(\pi\left(\mathbf{T}_{\mathrm{cur}, \mathrm{ref}} \pi^{-1}\left(\mathbf{p}_{i}\right)\right)\right)\right\|_{2}^{2}
$$
</p>

<p>其中N为点数，<code>π</code>函数为针孔相机的投影函数 $ R^3 → R^2 $，$π^{−1}$为反投影函数，$ W_ i$为第i个点周围的小窗口。同光流法，该问题可由<code>Gauss-Newton</code>函数求解。请回答下列问题，然后实现<code>code/direct_method.cpp</code>中的<code>DirectPoseEstimationSingleLayer</code>函数。
然后回答一下问题：</p>

<ol>
<li>该问题中的误差项是什么?</li>
<li>误差相对于自变量的雅可比维度是多少？如何求解？</li>
<li>窗又可以取多大？是否可以取单个点？</li>
</ol>

<p>下面是一些实现过程中的提示：</p>

<ol>
<li>这次我们在参考图像中随机取1000个点，而不是取角点。请思考为何不取角点,直接法也能工作。</li>
<li>由于相机运动，参考图像中的点可能在投影之后，跑到后续图像的外部。所以最后的目标函数要对投影在内部的点求平均误差，而不是对所有点求平均。程序中我们以<code>good</code>标记出投影在内部的点。</li>
<li>单层直接法的效果不会很好,但是你可以查看每次迭代的目标函数都会下降。</li>
</ol>

<h4 id="答案">答案：</h4>

<p>1.直接法的目标函数为：</p>

<p>
$$
\underset{\xi}{\operatorname{argmin}} \frac{1}{N} \sum_{i=0}^{N} \sum_{W_{i}}\left\|I_{1}\left(p_{1}, i\right)-I_{2}\left(p_{2}, i\right)\right\|^{2}
$$
</p>

<p>误差项为：</p>

<p>
$$
g(\xi)=I_{1}\left(p_{1}, i\right)-I_{2}\left(p_{2}, i\right)
$$
</p>

<p>其中$p_1,p_2$为相机归一化平面的坐标，$\xi$为$R,t$对应的李代数</p>

<p>
$$
p_1 = \frac{1}{Z_1}KP \\
p_2 = \frac{1}{Z_2}K(RP+t) = \frac{1}K(exp(\xi)P)_{1:3}
$$
</p>

<p>2.误差项相对于自变量的雅克比维度为$1\times 6$,大小计算可以通过自变量的个数进行判断，例如本题目中位姿的自由度为6，误差函数中的光度的变化，一维的数据，所以雅克比矩阵为$1\times 6$。上一讲中，求解PnP问题时，误差函数中自变量是像素的坐标，是一个二维的，所以对应的雅克比矩阵大小为$2\times 6$。具体的求解过程如下：</p>

<p>
$$
J(\xi)=\frac{\partial g}{\partial \delta \xi}=-\frac{\partial I_{2}}{\partial P_{u v}} \frac{\partial P_{u v}}{\partial P_{c}} \frac{\partial P_{c}}{\partial \delta \xi}
$$
</p>

<p>其中：</p>

<p>
$$
\frac{\partial P_{c}}{\partial \delta \xi}=\left[I,-P_{c}^{\wedge}\right]
$$
</p>

<p>
$$
\frac{\partial P_{u v}}{\partial P_{c}}=\left[ \begin{array}{ccc}{\frac{f_{x}}{z_{c}}} & {0} & {-\frac{f_{x} x_{c}}{z_{c}^{2}}} \\ {0} & {\frac{f_{y}}{z_{c}}} & {-\frac{f_{y} y_{c}}{z_{c}^{2}}}\end{array}\right]
$$
</p>

<p>最后带入所有的公式，我们可以求得雅克比矩阵为：</p>

<p>
$$
J(\xi)=-\frac{\partial I_{2}}{\partial P_{u v}} \frac{\partial P_{u v}}{\partial \delta \xi}=-\frac{\partial I_{2}}{\partial P_{u v}} \left[ \begin{array}{ccccc}{\frac{f_{x}}{z_{c}}} & {0} & {-\frac{f_{x} x_{c}}{z_{c}^{2}}} & {-\frac{f_{x} x_{c} y_{c}}{z_{c}^{2}}} & {f_{x}+\frac{f_{x} x_{c}^{2}}{z_{c}^{2}}} & {-\frac{f_{x} y_{c}}{z_{c}}} \\ {0} & {\frac{f_{y}}{z_{c}}} & {-\frac{f_{y} y_{c}}{z_{c}^{2}}} & {-f_{y}-\frac{f_{y} y_{c}^{2}}{z_{c}^{2}}} & {\frac{f_{y} x_{c} y_{c}}{z_{c}^{2}}} & {\frac{f_{y} x_{c}}{z_{c}}}\end{array}\right]
$$
</p>

<p>3.窗口的大小和误差以及运算量有关。在本题目中，同一个窗口内计算了像素梯度，但是采用了相同的深度信息，当像素块越大，像素块内的深度信息误差也越大；同时，窗口大小的增大，两帧之间的关键点的计算量将会呈指数增长。所以窗口不能取太大；
当然窗口可以取单个点。但是这样会导致像素梯度计算误差增大，在本题目中，取单个点之后估计结果比加窗口之后的小，误差增大。</p>

<h4 id="题记">题记：</h4>

<ol>
<li>对于本题目中，为什么随机选取角点也可以工作的原因在于：直接法是基于灰度不变的假设，对于任意点，在不同的图像中的灰度值均相同，从而通过大量随机点的光度误差最小化，求出相机的位姿，因此随机选取角点也可以正常工作；
此外，说一点自己的看法，SVO中使用的是FAST角点，以及ICIA光流法进行跟踪，之所以使用FAST特征点而不是随机的选取角点，是为了保证能够跟踪正确，即确保选取的角点周围存在光度的梯度，减少不必要的计算。</li>
</ol>

<p>最终的效果如下所示，我们能够清晰的看到相机是前向运动的。
<div style="text-align:center">
<img src="../images/视觉里程计2/sigle_layer_result.png">
</div></p>

<h3 id="2-2-多层直接法">2.2 多层直接法</h3>

<p>下面，类似于光流，我们也可以把直接法以<code>coarse-to-fine</code>的过程，拓展至多层金字塔。多层金字塔的直接法允许图像在发生较大运动时仍能追踪到所有点。下面我们使用缩放倍率为2的四层金字塔，实现金字塔上的直接法。请实现<code>DirectPoseEstimationMultiLayer</code>函数，下面是一些提示：</p>

<ol>
<li>在缩放图像时，图像内参也需要跟着变化。那么，例如图像缩小一倍，$f_x,f_y,c_x,c_y$应该如何变化？</li>
<li>根据<code>coarse-to-fine</code>的过程，上一层图像的位姿估计结果可以作为下一层图像的初始条件。</li>
<li>在调试期间，可以画出每个点在<code>ref</code>和<code>cur</code>上的投影，看看它们是否对应。若准确对应，则说明位姿估计是准确的。</li>
</ol>

<p>作为验证，图像<code>000001</code>和<code>000005</code>的位姿平移部分应该接近:</p>

<p>
$$
t_1 = [0.005876, −0.01024, −0.0725]^T \\
t_5 = [0.0394, −0.0592, −3.9907]^T
$$
</p>

<p>可以看出车辆基本是笔直向前开的。</p>

<h4 id="答案-1">答案：</h4>

<ol>
<li>缩放图像的时候，图像内参也需要跟着变化，首先平移参数$c_x,c_y$跟随图像进行缩放。$f_x,f_y$也需要进行相应的缩放，注意，此时$f_x,f_y$的单位是像素，表示焦距（单位为米）与缩放倍数（单位为像素/米）的乘积。</li>
<li>在使用图像金字塔的时候，和光流时一样，我们采用的时候<code>opencv</code>中<code>resize</code>函数，但是在实际的应用过程中，<code>OpenCV</code>改变图像大小的操作有两类<code>resize</code>与图像金字塔，但是这两类操作差别还是比较的。
<code>resize</code>函数的目标大小可以是任意的大小（不为0），可以不保持长宽比率；图像金字塔包含两个函数，<code>pyrDown</code>与<code>pyrUp</code>分别表示向下降采样与向上升采样，但是二者并不是互为逆操作，但是此时保持的是长宽比率是恒定的。这两个操作实现图像金字塔的经典操作，他们仅仅是分别代表一次采样操作，也就是说，向下(或者向上)进行相邻层次的金字塔采样，调用一次<code>pyrDown</code>函数只能降低到原图像尺寸的1/2；反之，调用<code>pyrUp</code>目标图像则为原图像尺寸的2倍。因为它们内部都给定了一次采样尺寸的约束。也就是说采样之后，长宽比基本是不变的。</li>
</ol>

<p>最终结果如图所示，和验证结果相差不大。
<div style="text-align:center">
<img src="../images/视觉里程计2/multi_layer_result.png">
</div>
同时下图展示了第一张图像进行金字塔的过程图(作为参考帧，右为当前帧)：
<div style="text-align:center">
<img src="../images/视觉里程计2/1_r.png"> <img src="../images/视觉里程计2/1_c.png">
</div>
<div style="text-align:center">
<img src="../images/视觉里程计2/2_r.png"> <img src="../images/视觉里程计2/2_c.png">
</div>
<div style="text-align:center">
<img src="../images/视觉里程计2/3_r.png" width='340'> <img src="../images/视觉里程计2/3_c.png" width='340'>
</div>
<div style="text-align:center">
<img src="../images/视觉里程计2/4_r.png" width='350'> <img src="../images/视觉里程计2/4_c.png" width='350'>
</div></p>

<h3 id="2-3-延伸讨论">2.3 延伸讨论</h3>

<p>现在你已经实现了金字塔上的<code>Gauss-Newton</code>直接法。你可以调整实验当中的一些参数，例如图像点数、每个点周围小块的大小等等。请思考下面问题：</p>

<ol>
<li>直接法是否可以类似光流，提出<code>inverse</code>，<code>compositional</code>的概念？它们有意义吗？</li>
<li>请思考上面算法哪些地方可以缓存或加速？</li>
<li>在上述过程中，我们实际假设了哪两个<code>patch</code>不变？</li>
<li>为何可以随机取点？而不用取角点或线上的点？那些不是角点的地方,投影算对了吗？</li>
<li>请总结直接法相对于特征点法的异同与优缺点。</li>
</ol>

<h4 id="答案-2">答案：</h4>

<ol>
<li>理论上认为，直接法可类似光流法提出<code>inverse、compositional</code>概念，目前这一块存疑，后续会有更深入的补充。</li>
<li>加速的思路有两种，第一种是直接更改窗口的大小，减少计算量。第二种办法是当窗口大小固定时，假设小窗口内的 $8\times 8$ 个像素，对应在相机坐标系下是同一个点，即小窗口内的所有像素在相机坐标系下的坐标相等，这样每一个窗口只需要计算一次雅各比矩阵，进而提高效率。</li>
<li>在本题目中有两个地方，第一个是<code>patch</code>内关键点的灰度值不变假设；第二个是<code>patch</code>内点的深度信息不变（采用了一样的深度信息$Z_2$）。</li>
<li>因为直接法是基于灰度不假设，对于任意点，在不同图像中的灰度值均相同，从而通过大量随机点的光度误差最小值，求出相机位姿。因此，无所谓是否为角点。但是选取角点的话，基本能够确保该点的梯度值存在，例如半直接法<code>SVO</code>中选取的是<code>FAST</code>特征点。
在本题目中，那些不是角点的随机点，跟踪的结果基本上是正确的，但是在图像右上方白墙上有些点的跟踪结果有偏差。</li>

<li><p>直接法和特征点法的比较：</p>

<p>直接法的优点：</p>

<ul>
<li>可以省去计算特征点和描述子的时间；</li>
<li>只要求有像素梯度即可，不需要特征点。因此直接法可以在特征缺失的场合下使用。比较极端的例子是只有渐变的一副图像。他可能无法提取角点类特征，但可以用直接法估计他的运动；</li>
<li>可以构建半稠密乃至稠密的地图，这是特征点法无法做到的。<br /></li>
</ul>

<p>直接法的缺点：</p>

<ul>
<li>非凸性，容易陷入局部极小值；</li>
<li>单个像素没有区分度；</li>
<li>灰度值不变的假设是很强的假设，相机存在曝光、或者物体有高光或者阴影、相机运动过快时，均容易失败。</li>
</ul>

<p>特征点法的优点：</p>

<ul>
<li>对光照有一定的容忍度；</li>
<li>运动过大时，只要图像中还有匹配的点，则不容易丢失，有更好的鲁棒性。</li>
</ul>

<p>特征点法的缺点：</p>

<ul>
<li>当环境纹理的特征点少的时候，容易失败，当特征点过于集中时容易产生退化；</li>
<li>相机运动过快，图像模糊的时候容易失败；</li>
<li>特征点计算耗时。</li>
</ul></li>
</ol>

<p>完整程序链接：<a href="https://github.com/XLMaverick/Visual-Localization-Percessing/tree/master/vslam_fourteen_lectures/direct_method">https://github.com/XLMaverick/Visual-Localization-Percessing/tree/master/vslam_fourteen_lectures/direct_method</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Yang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-05-20</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://xlmaverick.me/tags/slam/">slam</a>
          <a href="https://xlmaverick.me/tags/%E5%8D%81%E5%9B%9B%E8%AE%B2/">十四讲</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/%E5%9F%BA%E4%BA%8E%E6%B6%88%E5%A4%B1%E7%82%B9%E7%9A%84%E7%9B%B8%E6%9C%BA%E4%BF%AF%E4%BB%B0%E8%A7%92%E5%92%8C%E5%81%8F%E8%88%AA%E8%A7%92%E5%A4%96%E5%8F%82%E6%9B%B4%E6%96%B0/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">基于消失点的相机俯仰角和偏航角的更新方法</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12-lk/">
            <span class="next-text nav-default">视觉里程计2-LK</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://xlmaverick.me/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'https-www-xlmaverick-me';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:yangxl0319@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/XLMaverick" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/yang-xing-long-32/activities" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/388127809" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://xlmaverick.me/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Yang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("L1Y08x6DoPUETcsGl1esNXJp-gzGzoHsz", "wqmpINfqc3gXUrss93yVtQOa");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>







</body>
</html>
