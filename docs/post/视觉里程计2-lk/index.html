<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>视觉里程计2-LK - XLMaverick - garabatear of yang</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Yang" />
  <meta name="description" content="视觉里程计2 习题一：LK光流法 1.1 光流文献综述 我们课上演示了Lucas-Kanade稀疏光流，用OpenCV函数实现了光流法追踪特征点。实际上" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.48" />


<link rel="canonical" href="https://xlmaverick.me/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12-lk/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b1679e57eeea2063968c2297b106a28a5f8588a822aaea6ec3e802853d3ee8cb.css" integrity="sha256-sWeeV&#43;7qIGOWjCKXsQaiil&#43;FiKgiqupuw&#43;gChT0&#43;6Ms=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="视觉里程计2-LK" />
<meta property="og:description" content="视觉里程计2 习题一：LK光流法 1.1 光流文献综述 我们课上演示了Lucas-Kanade稀疏光流，用OpenCV函数实现了光流法追踪特征点。实际上" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xlmaverick.me/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12-lk/" /><meta property="article:published_time" content="2019-05-16T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-05-20T00:00:00&#43;00:00"/>
<meta itemprop="name" content="视觉里程计2-LK">
<meta itemprop="description" content="视觉里程计2 习题一：LK光流法 1.1 光流文献综述 我们课上演示了Lucas-Kanade稀疏光流，用OpenCV函数实现了光流法追踪特征点。实际上">


<meta itemprop="datePublished" content="2019-05-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-05-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="5609">



<meta itemprop="keywords" content="slam,十四讲," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="视觉里程计2-LK"/>
<meta name="twitter:description" content="视觉里程计2 习题一：LK光流法 1.1 光流文献综述 我们课上演示了Lucas-Kanade稀疏光流，用OpenCV函数实现了光流法追踪特征点。实际上"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">XLMaverick</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/post/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/about/">关于</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      XLMaverick
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/post/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://xlmaverick.me/about/">关于</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">视觉里程计2-LK</h1>
      
      <div class="post-meta">
        <time datetime="2019-05-16" class="post-time">
          2019-05-16
        </time>
        <div class="post-category">
            <a href="https://xlmaverick.me/categories/slam/"> slam </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
          <span id="/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12-lk/" class="leancloud_visitors" data-flag-title="视觉里程计2-LK">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#视觉里程计2">视觉里程计2</a>
<ul>
<li><a href="#习题一-lk光流法">习题一：LK光流法</a>
<ul>
<li><a href="#1-1-光流文献综述">1.1 光流文献综述</a>
<ul>
<li><a href="#答案">答案：</a></li>
<li><a href="#题记">题记</a></li>
</ul></li>
<li><a href="#1-2-forward-addtive-gauss-newton-光流的实现">1.2 <code>forward-addtive Gauss-Newton</code>光流的实现</a>
<ul>
<li><a href="#答案-1">答案：</a></li>
<li><a href="#题记-1">题记</a></li>
</ul></li>
<li><a href="#1-3-反向法">1.3 反向法</a>
<ul>
<li><a href="#答案-2">答案：</a></li>
</ul></li>
<li><a href="#2-4-推广至金字塔">2.4 推广至金字塔</a>
<ul>
<li><a href="#答案-3">答案：</a></li>
</ul></li>
<li><a href="#2-5-讨论">2.5 讨论</a>
<ul>
<li><a href="#答案-4">答案：</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h1 id="视觉里程计2">视觉里程计2</h1>

<h2 id="习题一-lk光流法">习题一：LK光流法</h2>

<h3 id="1-1-光流文献综述">1.1 光流文献综述</h3>

<p>我们课上演示了<code>Lucas-Kanade</code>稀疏光流，用<code>OpenCV</code>函数实现了光流法追踪特征点。实际上，光流法有很长时间的研究历史，直到现在人们还在尝试用<code>Deep learning</code>等方法对光流进行改进。本题将指导你完成基于<code>Gauss-Newton</code>的金字塔光流法。首先，请阅读文献，回答下列问题。
问题:</p>

<ol>
<li>按此文的分类,光流法可分为哪几类?</li>
<li>在<code>compositional</code>中，为什么有时候需要做原始图像的<code>wrap</code>？该<code>wrap</code>有何物理意义?</li>
<li><code>forward</code>和<code>inverse</code>有何差别?</li>
</ol>

<h4 id="答案">答案：</h4>

<p>1.围绕Image Alignment，文章总共介绍了四种方法，分别是<code>FAIA（Forward Additional Image Alignment）</code>，<code>FCIA（Forward Composition Image Alignment）</code>，<code>ICIA(Inverse Compositional Image Alignment</code>)和<code>IAIA（Inverse Additional Image Alignment）</code>。其中LK对应上述四种中的<code>FAIA</code>，<code>ICIA</code>使用于直接法SVO中块匹配方法。</p>

<table>
<thead>
<tr>
<th>增量方式\更新方式</th>
<th align="right">forward</th>
<th align="center">inverse</th>
</tr>
</thead>

<tbody>
<tr>
<td>additive</td>
<td align="right">FAIA</td>
<td align="center">IAIA</td>
</tr>

<tr>
<td>compositional</td>
<td align="right">FCIA</td>
<td align="center">ICIA</td>
</tr>
</tbody>
</table>

<p>2.首先，我们区分一下<code>compositional</code>和<code>additive</code>两种方法，其中：如果迭代的结果是在原始的值（6个运动参数）上增加一个微小量，那么这种方法成为<code>additive</code>；如果在放射矩阵上乘以一个矩阵（增量运动参数形成的增量放射矩阵），这种方法称为<code>compositional</code>。这两种方法理论上是等效的，计算量也差不多。<br />
针对<code>compositional</code>的两种计算方式<code>FCIA</code>，<code>ICIA</code>，都需要在当前位姿估计之前引入增量式<code>warp</code>以建立半群约束要求。<br />
FCIA：<code>warp</code>集合包含<code>identity warp</code>，<code>warp</code>集合包含在<code>compositional</code>操作上是闭的（<code>semi-group</code>），其中包含<code>Homograph，3D rotation</code>等。<br />
ICIA：<code>semi-group</code>，另外要求增量<code>warp</code>可逆，其中包括<code>Homograph，3D rotation</code>等，但是不包括<code>piece wise affine</code>。
<code>warp</code>的物理意义：对图像做微小的平移或者仿射变换。<br />
3.前向（<code>forward</code>）和后向（<code>inverse</code>）的对比：<br />
前向方法对于输入图像进行参数化（包括放射变换以及放射增量）。后向方法则是同时参数化输入图像和模板图像，其中输入图像参数化仿射变换，模板图像参数化放射增量。因此后向方法的计算量显著降低。由于图像灰度值和运动参数非线性化，整个优化过程为非线性的。<br />
参数化过程主要计算：图像的梯度，位置对运动参数导数，运动参数增量。前向方法中<code>Hessian</code>是运动参数的函数，提高效率的主要思想是交换模板图像和输入图像的角色；后向方法中，迭代中的<code>Hessian</code>是固定的。<br />
前向方法和后向方法在目标函数上不太一样，一个是把运动向量$p$都是跟着$I$（被匹配的图像），但是前向方法中的迭代的微小的量$Δp$使用I计算，后向方法中的$Δp$使用$T$计算，这样计算量变小。</p>

<h4 id="题记">题记</h4>

<ol>
<li>两个前向方法的计算复杂度相似，后向方法几乎相等。后向方法的速度远远比前向方法要快；</li>
<li>前向<code>additive</code>可以用于任何变形<code>warp</code>；</li>
<li>反向<code>compositional</code>只能用于<code>wraps that form groups</code>；</li>
<li>反向<code>additive</code>可以用于<code>simple 2D linear warps such as translations and affine warps</code>。</li>
<li>如果不考虑效率的话，可以使用两种前向方法。前向<code>compositional</code>的方法中<code>Jacobian</code>是常量，因此具有一定的优势；</li>
<li>如果考虑效率的话，那么后向<code>compositional</code>方法是首选，推导简单，很容易确定；</li>
<li><code>Jacobian</code>矩阵和残差计算的方式有关，由于<code>compositional</code>计算误差的方式会使得雅克比矩阵为常数，通常采用<code>compositional</code>；</li>
<li>最后的最后，推荐一篇博客，对LK光流的解释以及对相应公式的推导均写的较为详细 <a href="https://www.twblogs.net/a/5b8190582b71772165ad3c9b">https://www.twblogs.net/a/5b8190582b71772165ad3c9b</a><br />
<a href="https://blog.csdn.net/wendox/article/details/52505971">https://blog.csdn.net/wendox/article/details/52505971</a><br /></li>
</ol>

<h3 id="1-2-forward-addtive-gauss-newton-光流的实现">1.2 <code>forward-addtive Gauss-Newton</code>光流的实现</h3>

<p>接下来我们来实现最简单的光流，即上文所说的<code>forward-addtive</code>。我们先考虑单层图像的<code>LK</code>光流，然后再推广至金字塔图像。按照教材的习惯，我们把光流法建模成一个非线性优化问题，再使用<code>Gauss-Newton</code>法迭代求解。设有图像<code>1.png</code>，<code>2.png</code>，我们在<code>1.png</code>中提取了<code>GFTT</code>角点，然后希望在<code>2.png</code>中追踪这些关键点。设两个图分别为$I_1$，$I_2$，第一张图中提取的点集为$P = {p_i}$，其中$p_i = [x_i,y_i]^T$为像素坐标值。考虑第i个点，我们希望计算$∆x_i, ∆y_i$，满足:</p>

<p>
$$
\min _{\Delta x_{i}, \Delta y_{i}} \sum_{W}\left\|I_{1}\left(x_{i}, y_{i}\right)-I_{2}\left(x_{i}+\Delta x_{i}, y_{i}+\Delta y_{i}\right)\right\|_{2}^{2}
$$
</p>

<p>即最小化二者灰度差的平方，其中$ \sum_{W}$表示我们在某个窗口（<code>Window</code>）中求和（而不是单个像素，因为问题有两个未知量,单个像素只有一个约束,是欠定的）。实践中，取此<code>window</code>为$8×8$大小的小块,即从$x_i − 4$取到$x_i + 3$，<code>y</code>坐标亦然。显然,这是一个<code>forward-addtive</code>的光流，而上述最小二乘问题可以用<code>Gauss-Newton</code>迭代求解。请回答下列问题，并根据你的回答，实现<code>codeoptical_flow.cpp</code>文件中的<code>OpticalFlowSingleLevel</code>函数。</p>

<ol>
<li>从最小二乘角度来看，每个像素的误差怎么定义？</li>
<li>误差相对于自变量的导数如何定义？</li>
</ol>

<p>下面是有关实现过程中的一些提示:</p>

<ol>
<li>同上一次作业，你仍然需要去除那些提在图像边界附近的点，不然你的图像块可能越过边界。</li>
<li>该函数称为单层的光流，下面我们要基于这个函数来实现多层的光流。在主函数中，我们对两张图像分别测试单层光流、多层光流，并与<code>OpenCV</code>结果进行对比。作为验证，正向单层光流结果应该如图1所示，它结果不是很好，但大部分还是对的。</li>
<li>在光流中，关键点的坐标值通常是浮点数，但图像数据都是以整数作为下标的。之前我们直接取了浮点数的整数部分，即把小数部分归零。但是在光流中，通常的优化值都在几个像素内变化，所以我们还用浮点数的像素插值。函数<code>GetPixelValue</code>为你提供了一个双线性插值方法(这也是常用的图像插值法之一)，你可以用它来获得浮点的像素值。</li>
</ol>

<h4 id="答案-1">答案：</h4>

<ol>
<li>从最小二乘的角度，每个像素的误差为：</li>
</ol>

<p>$$
g(p) = I(W(x;p+∆p)) - T(x)
$$</p>

<ol>
<li>误差相对于自变量的导数为：</li>
</ol>

<p>$$
\frac{\partial g}{\partial p}=\nabla \mathrm{I} \frac{\partial W}{\partial p}=\left[\frac{\partial I}{\partial x}, \frac{\partial I}{\partial y}\right]
$$</p>

<p>最终结果为：(右边为opencv结果)</p>

<div style="text-align:center">
<img src="../images/视觉里程计-LK/single_f.png" width='350'> <img src="../images/视觉里程计-LK/opencv_op.png"  width="350">
</div>

<h4 id="题记-1">题记</h4>

<ol>
<li>对于LK光流的总结和公式推导:<br />
<a href="https://blog.csdn.net/sgfmby1994/article/details/68489944。">https://blog.csdn.net/sgfmby1994/article/details/68489944。</a></li>
</ol>

<h3 id="1-3-反向法">1.3 反向法</h3>

<p>在你实现了上述算法之后，就会发现，在迭代开始时，<code>Gauss-Newton</code>的计算依赖于$I_2$在$(x_i,y_i)$处的梯度信息。然而，角点提取算法仅保证了$I_1(x_i,y_i)$处是角点(可以认为角度点存在明显梯度)，但对于$I_2$，我们并没有办法假设$I_2$在$x_i,y_i$处亦有梯度，从而<code>Gauss-Newton</code>并不一定成立。反向的光流法(inverse)则做了一个巧妙的技巧，即用$I_1(x_i,y_i)$处的梯度，替换掉原本要计算的$I_2 (x_i + ∆x_i,y_i+∆y_i)$的梯度。这样做的好处有:</p>

<ul>
<li>$I_1(x_i,y_i)$是角点，梯度总有意义；</li>
<li>$I_1(x_i,y_i)$处的梯度不随迭代改变，所以只需计算一次，就可以在后续的迭代中一直使用，节省了大量计算时间。</li>
</ul>

<p>我们为<code>OpticalFlowSingleLevel</code>函数添加一个<code>bool inverse</code>参数，指定要使用正常的算法还是反向的算法。请你根据上述说明，完成反向的<code>LK</code>光流法。</p>

<h4 id="答案-2">答案：</h4>

<ol>
<li>正向和后向的区别在于关键点梯度的计算上面。正向是计算第二张片的梯度，后向是计算第一张图片的梯度。</li>
</ol>

<p>最终结果如下（左为正向，右为后向）：
<div style="text-align:center">
<img src="../images/视觉里程计-LK/single_f.png" width="350"> <img src="../images/视觉里程计-LK/single_i.png"  width="350">
</div></p>

<p>最终结果如下（左为后向，右为opencv）：</p>

<div style="text-align:center">
<img src="../images/视觉里程计-LK/single_i.png" width="350"> <img src="../images/视觉里程计-LK/opencv_op.png"  width="350">
</div>

<h3 id="2-4-推广至金字塔">2.4 推广至金字塔</h3>

<p>通过实验，可以看出光流法通常只能估计几个像素内的误差。如果初始估计不够好，或者图像运动太大，光流法就无法得到有效的估计(不像特征点匹配那样)。但是，使用图像金字塔，可以让光流对图像运动不那么敏感。下面请你使用缩放倍率为2，共四层的图像金字塔，实现<code>coarse-to-fine</code>的<code>LK</code>光流。函数在<code>OpticalFlowMultiLevel</code>中。</p>

<p>实现完成后，给出你的光流截图(正向、反向、金字塔正向、金字塔反向)，可以和<code>OpenCV</code>作比较。然后回答下列问题:</p>

<ol>
<li>所谓<code>coarse-to-fine</code>是指怎样的过程？</li>
<li>光流法中的金字塔用途和特征点法中的金字塔有何差别？
提示:你可以使用上面写的单层光流来帮助你实现多层光流。</li>
</ol>

<h4 id="答案-3">答案：</h4>

<ol>
<li>所谓的<code>coarse-to-fine</code>是指：先跟踪金字塔的最顶层，然后用被跟踪帧在最顶层的跟踪结果，作为次顶层的跟踪初始值，再次进行跟踪，依次至第0层（原始图像）。相当于从低分辨率（对运动不敏感）的图像开始跟踪，向高精度图像进行逐层迭代，从而得到一个更为准确的关键点和光流的过程。</li>
<li>光流法中的金字塔是逐层迭代寻找最佳的关键点位置和光流方向（像素梯度），目的是解决光流在运动过程中难以检测的问题；同时图像中的金字塔也是为了排除图像运动过快导致跟踪不上的问题，因此可以跟踪金字塔上层下采样后的图像，然后层层细化。
特征点法中的金字塔是通过逐层检测特征点来增加尺度描述，目的是解决特征点的尺度不变性问题。特征点中的金字塔是为了排除焦点距离的影响，即从远处看是一个特征点，但是近看时却不是，当近看时可以用金字塔的上面几层来跟踪，实现尺度的不变性。</li>
</ol>

<p>最终结果如下：（左为正向，右为金字塔正向）
<div style="text-align:center">
<img src="../images/视觉里程计-LK/single_f.png" width="350"> <img src="../images/视觉里程计-LK/multi_f.png"  width="350">
</div></p>

<p>左为后向，右为金字塔后向：
<div style="text-align:center">
<img src="../images/视觉里程计-LK/single_i.png" width="350"> <img src="../images/视觉里程计-LK/multi_i.png"  width="350">
</div></p>

<h3 id="2-5-讨论">2.5 讨论</h3>

<p>现在你已经自己实现了光流，看到了基于金字塔的<code>LK</code>光流能够与<code>OpenCV</code>达到相似的效果(甚至更好)。根据光流的结果，你可以和上讲一样，计算对极几何来估计相机运动。下面针对本次实验结果，谈谈你对下面问题的看法：</p>

<ul>
<li>我们优化两个图像块的灰度之差真的合理吗？哪些时候不够合理？你有解决办法吗？</li>
<li>图像块大小是否有明显差异？取$16 \times 16 $和$8 \times 8$的图像块会让结果发生变化吗？</li>
<li>金字塔层数对结果有怎样的影响?缩放倍率呢？</li>
</ul>

<h4 id="答案-4">答案：</h4>

<ol>
<li>光流法有三个基本的假设：a：灰度不变假设；b：小运动假设；c：局部一致性假设。
其中，灰度不变假设，当相机存在自动曝光或者当物体有强光或者阴影时，灰度不变的建设是不成立的。通常的解决办法是，对相机进行光度模型标定，将图像校正到一致的状态。
本题中金字塔的方法是对运动较大时的一种解决方法。</li>
<li>当采用了金字塔的方法时，窗口固定，将图像生成金字塔过程中，在每一层金字塔上都用同一个大小的窗口来进行光流计算，这样很好的去解决了图像块的问题，这样一来图像块大小并不会带来明显差异。<br />
当没有采用金字塔方法时。当窗口较大时，光流计算更鲁棒，当窗口较小时，光流计算更正确。原因在于，当图像中每一个部分的运动都不一致的时候，如果开的窗口过大，很容易违背窗口(邻域)内的所有点光流一致的基本假设，这可能与实际不一致，所以窗口小，包含的像素少，更精确些。<br />
在本题中，当图像块从$8×8$调到$16×16$，多层金字塔效果不明显，单程<code>IAIA</code>效果略有改善。</li>
<li>金字塔层数一般越多效果越好，但是一般图像大于4~5层之后都变得太小，特征点像素太过紧密容易出现错误追踪。放大倍率同样的道理，放大倍率小，金字塔的层数可以增加，迭代层数增多，效果自然要好。
对于本题中，将金字塔数从4层改为6层，结果基本无差别；将4层的缩放倍率从0.5改为0.25，结果基本无差别。</li>
</ol>

<p>完整程序链接：<a href="https://github.com/XLMaverick/Visual-Localization-Percessing/tree/master/vslam_fourteen_lectures/optical_flow">https://github.com/XLMaverick/Visual-Localization-Percessing/tree/master/vslam_fourteen_lectures/optical_flow</a></p>

<p>本题相关完整代码如下：</p>

<pre><code>inline float GetPixelValue(const cv::Mat &amp;img, float x, float y) 
{
    uchar *data = &amp;img.data[int(y) * img.step + int(x)];
    float xx = x - floor(x);
    float yy = y - floor(y);
    return float(
            (1 - xx) * (1 - yy) * data[0] +
            xx * (1 - yy) * data[1] +
            (1 - xx) * yy * data[img.step] +
            xx * yy * data[img.step + 1]
    );
}

int main(int argc, char **argv) {

    // images, note they are CV_8UC1, not CV_8UC3
    Mat img1 = imread(file_1, 0);
    Mat img2 = imread(file_2, 0);

    // key points, using GFTT here.
    vector&lt;KeyPoint&gt; kp1;
    Ptr&lt;GFTTDetector&gt; detector = GFTTDetector::create(500, 0.01, 20); // maximum 500 keypoints
    detector-&gt;detect(img1, kp1);

    // now lets track these key points in the second image
    // first use single level LK in the validation picture
    vector&lt;KeyPoint&gt; kp2_single;
    vector&lt;bool&gt; success_single;
    OpticalFlowSingleLevel(img1, img2, kp1, kp2_single, success_single);

    // then test multi-level LK
    vector&lt;KeyPoint&gt; kp2_multi;
    vector&lt;bool&gt; success_multi;
    OpticalFlowMultiLevel(img1, img2, kp1, kp2_multi, success_multi);

    // use opencv's flow for validation
    vector&lt;Point2f&gt; pt1, pt2;
    for (auto &amp;kp: kp1) pt1.push_back(kp.pt);
    vector&lt;uchar&gt; status;
    vector&lt;float&gt; error;
    cv::calcOpticalFlowPyrLK(img1, img2, pt1, pt2, status, error, cv::Size(8, 8));

    // plot the differences of those functions
    Mat img2_single;
    cv::cvtColor(img2, img2_single, CV_GRAY2BGR);
    for (int i = 0; i &lt; kp2_single.size(); i++) {
        if (success_single[i]) {
            cv::circle(img2_single, kp2_single[i].pt, 2, cv::Scalar(0, 250, 0), 2);
            cv::line(img2_single, kp1[i].pt, kp2_single[i].pt, cv::Scalar(0, 250, 0));
        }
    }

    Mat img2_multi;
    cv::cvtColor(img2, img2_multi, CV_GRAY2BGR);
    for (int i = 0; i &lt; kp2_multi.size(); i++) {
        if (success_multi[i]) {
            cv::circle(img2_multi, kp2_multi[i].pt, 2, cv::Scalar(0, 250, 0), 2);
            cv::line(img2_multi, kp1[i].pt, kp2_multi[i].pt, cv::Scalar(0, 250, 0));
        }
    }

    Mat img2_CV;
    cv::cvtColor(img2, img2_CV, CV_GRAY2BGR);
    for (int i = 0; i &lt; pt2.size(); i++) {
        if (status[i]) {
            cv::circle(img2_CV, pt2[i], 2, cv::Scalar(0, 250, 0), 2);
            cv::line(img2_CV, pt1[i], pt2[i], cv::Scalar(0, 250, 0));
        }
    }

    cv::imshow(&quot;tracked single level&quot;, img2_single);
    cv::imwrite(&quot;../single_i.png&quot;, img2_single);
    cv::imshow(&quot;tracked multi level&quot;, img2_multi);
    cv::imwrite(&quot;../multi_i.png&quot;, img2_multi);
    cv::imshow(&quot;tracked by opencv&quot;, img2_CV);
    cv::imwrite(&quot;../opencv_op.png&quot;, img2_CV);
    cv::waitKey(0);

    return 0;
}

void OpticalFlowSingleLevel(
        const Mat &amp;img1,
        const Mat &amp;img2,
        const vector&lt;KeyPoint&gt; &amp;kp1,
        vector&lt;KeyPoint&gt; &amp;kp2,
        vector&lt;bool&gt; &amp;success,
        bool inverse
) {

    // parameters
    int half_patch_size = 4;
    int iterations = 10;
    bool have_initial = !kp2.empty();

    for (size_t i = 0; i &lt; kp1.size(); i++) 
    {
        auto kp = kp1[i];
        double dx = 0, dy = 0; // dx,dy need to be estimated
        if (have_initial) 
        {
            dx = kp2[i].pt.x - kp.pt.x;
            dy = kp2[i].pt.y - kp.pt.y;
        }

        double cost = 0, lastCost = 0;
        bool succ = true; // indicate if this point succeeded

        // Gauss-Newton iterations
        for (int iter = 0; iter &lt; iterations; iter++) 
        {
            Eigen::Matrix2d H = Eigen::Matrix2d::Zero();
            Eigen::Vector2d b = Eigen::Vector2d::Zero();
            cost = 0;

            if (kp.pt.x + dx &lt;= half_patch_size || kp.pt.x + dx &gt;= img1.cols - half_patch_size ||
                kp.pt.y + dy &lt;= half_patch_size || kp.pt.y + dy &gt;= img1.rows - half_patch_size) 
            {   // go outside
                succ = false;
                break;
            }

            // compute cost and jacobian
            for (int x = -half_patch_size; x &lt; half_patch_size; x++)
                for (int y = -half_patch_size; y &lt; half_patch_size; y++) 
                {
                    double error = 0;
                    float u1 = float(kp.pt.x + x), v1 = float(kp.pt.y+y);
                    float u2 = float(u1+dx), v2 = float(v1+dy);
                    Eigen::Vector2d J;  // Jacobian
                    if (inverse == false) 
                    {
                        J.x() = double(GetPixelValue(img2,u2+1,v2) - GetPixelValue(img2,u2-1,v2))/2;
                        J.y() = double(GetPixelValue(img2,u2,v2+1) - GetPixelValue(img2,u2,v2-1))/2;
                        error = double(GetPixelValue(img2,u2,v2) - GetPixelValue(img1,u1,v1));
                        // Forward Jacobian
                    } else 
                    {
                        // Inverse Jacobian
                        // NOTE this J does not change when dx, dy is updated, so we can store it and only compute error
                        J.x() = double(GetPixelValue(img1,u1+1,v1) - GetPixelValue(img1,u1-1,v1))/2;
                        J.y() = double(GetPixelValue(img1,u1,v1+1) - GetPixelValue(img1,u1,v1-1))/2;
                        error = double(GetPixelValue(img2,u2,v2) - GetPixelValue(img1,u1,v1));
                    }

                    H += J*J.transpose();
                    b += -J*error;
                    cost += error*error;
                }

            // compute update
            Eigen::Vector2d update;
            update = H.ldlt().solve(b);

            if (isnan(update[0])) 
            {
                // sometimes occurred when we have a black or white patch and H is irreversible
                cout &lt;&lt; &quot;update is nan&quot; &lt;&lt; endl;
                succ = false;
                break;
            }
            if (iter &gt; 0 &amp;&amp; cost &gt; lastCost) 
            {
                cout &lt;&lt; &quot;cost increased: &quot; &lt;&lt; cost &lt;&lt; &quot;, &quot; &lt;&lt; lastCost &lt;&lt; endl;
                break;
            }

            // update dx, dy
            dx += update[0];
            dy += update[1];
            lastCost = cost;
            succ = true;
        }
        success.push_back(succ);
        // set kp2
        if (have_initial) 
        {
            kp2[i].pt = kp.pt + Point2f(dx, dy);
        } else 
        {
            KeyPoint tracked = kp;
            tracked.pt += cv::Point2f(dx, dy);
            kp2.push_back(tracked);
        }
    }
}

void OpticalFlowMultiLevel(
        const Mat &amp;img1,
        const Mat &amp;img2,
        const vector&lt;KeyPoint&gt; &amp;kp1,
        vector&lt;KeyPoint&gt; &amp;kp2,
        vector&lt;bool&gt; &amp;success,
        bool inverse) {

    // parameters
    int pyramids = 4;
    double pyramid_scale = 0.5;
    double scales[] = {1.0, 0.5, 0.25, 0.125};

    // create pyramids
    vector&lt;Mat&gt; pyr1, pyr2; // image pyramids
    // TODO START YOUR CODE HERE (~8 lines)
    for (int i = 0; i &lt; pyramids; i++) 
    {
        Mat img1_temp, img2_temp;
        resize(img1, img1_temp,Size(img1.cols*scales[i], img1.rows*scales[i]));
        resize(img2, img2_temp,Size(img2.cols*scales[i], img2.rows*scales[i]));
        pyr1.push_back(img1_temp);
        pyr2.push_back(img2_temp);
        cout&lt;&lt;&quot;Pyramid&quot;&lt;&lt;i&lt;&lt;&quot;im1 size: &quot;&lt;&lt;img1_temp.cols&lt;&lt;&quot; &quot; &lt;&lt;img1_temp.rows&lt;&lt;endl;
    }
    // coarse-to-fine LK tracking in pyramids
    vector&lt;KeyPoint&gt; vkp2_now;
    vector&lt;KeyPoint&gt; vkp2_last;
    vector&lt;bool&gt; vsucc;
    for(int i = pyramids-1;i&gt;=0;i--)
    {
        vector&lt;KeyPoint&gt; vkp1;
        for(int j = 0; j&lt;kp1.size();j++)
        {
            KeyPoint kp1_temp = kp1[j];
            kp1_temp.pt *= scales[i];
            vkp1.push_back(kp1_temp);
            if(i&lt;pyramids-1)
            {
                KeyPoint kp2_temp = vkp2_last[j];
                kp2_temp.pt /= pyramid_scale;
                vkp2_now.push_back(kp2_temp);
            }
        }
        vsucc.clear();
        OpticalFlowSingleLevel(pyr1[i], pyr2[i], vkp1, vkp2_now, vsucc, inverse);
        vkp2_last.clear();
        vkp2_last.swap(vkp2_now);
        cout&lt;&lt;&quot;pyramid: &quot;&lt;&lt;i&lt;&lt;&quot;vkp2_last size: &quot;&lt;&lt;vkp2_last.size()&lt;&lt;&quot;vkp2_noe size &quot;&lt;&lt;vkp2_now.size()&lt;&lt;endl;
    }
    kp2 = vkp2_last;
    success = vsucc;
    // TODO END YOUR CODE HERE
    // don't forget to set the results into kp2
}
</code></pre>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Yang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-05-20</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://xlmaverick.me/tags/slam/">slam</a>
          <a href="https://xlmaverick.me/tags/%E5%8D%81%E5%9B%9B%E8%AE%B2/">十四讲</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">视觉里程计2</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/">
            <span class="next-text nav-default">视觉里程计1</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://xlmaverick.me/post/%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12-lk/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'https-www-xlmaverick-me';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:yangxl0319@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/XLMaverick" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/yang-xing-long-32/activities" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/388127809" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://xlmaverick.me/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Yang
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("L1Y08x6DoPUETcsGl1esNXJp-gzGzoHsz", "wqmpINfqc3gXUrss93yVtQOa");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>







</body>
</html>
